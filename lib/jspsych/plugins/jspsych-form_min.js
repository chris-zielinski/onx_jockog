jsPsych.plugins["form"]=(function(){var plugin={};function define_trial(params){var formi=params.form_struct;var formf=[];var allidcond=[];for(var i=0;i<formi.length;i++){var fip=formi[i];var typ=(typeof fip.type=='undefined')?"text":fip.type;var idn=(typeof fip.idname=='undefined')?"Q"+i:fip.idname;var qstr=(typeof fip.quest=='undefined')?"":fip.quest;var nch=(typeof fip.input_nchar=='undefined')?20:fip.input_nchar;var ostr=(typeof fip.opt_str=='undefined')?"":fip.opt_str;var oid=(typeof fip.opt_id=='undefined')?"":fip.opt_id;var nmax=(typeof fip.checklim=='undefined')?0:fip.checklim;var ishid=(typeof fip.visible_if=='undefined')?false:true;var condvis=(typeof fip.visible_if=='undefined')?[]:fip.visible_if;if(ishid==true){for(var ic=0;ic<condvis.length;ic++){if($.inArray(condvis[ic],allidcond)==-1){allidcond.push(condvis[ic]);}}}
var strclass="";for(var k=0;k<condvis.length;k++){strclass+="cond_"+condvis[k]+" ";if(k==condvis.length-1){strclass+="hiderow";}}
if((typ=="text"&&qstr!="")||(typ=="radio"&&ostr!="")||(typ=="list"&&ostr!="")||(typ=="checkbox"&&ostr!="")){formf.push({type:typ,idname:idn,quest:qstr,inpwidth:Math.floor(nch*0.7),optstr:ostr,optid:oid,ncblim:nmax,ishidden:ishid,visible_if:condvis,condclass:strclass});}}
for(var j=0;j<formf.length;j++){var fel=formf[j];var Nopt=fel.optid.length;var optfunc=[];for(var io=0;io<Nopt;io++){if($.inArray(fel.optid[io],allidcond)>-1){optfunc.push(1);}else{optfunc.push(0);}}
formf[j].optfunc=optfunc;}
var trials={preamble:(typeof params.preamble=='undefined')?"":params.preamble,form_element:formf,nrow:formf.length,submit:(typeof params.submit=='undefined')?"Submit":params.submit,progbar:(typeof params.progbarstr==='undefined')?"":params.progbarstr};return trials;};plugin.trial=function(display_element,params){trial=define_trial(params);trial=jsPsych.pluginAPI.evaluateFunctionParameters(trial);function addoptfunc(isfunc,$opt){if(isfunc===1){var rnam=$opt.attr('name');var idtrig=$opt.attr('id');$opt.click(function(){$(".cond_"+idtrig).removeClass("hiderow");$('[name='+rnam+']').each(function(){var idopt=$(this).attr('id');$(this).click(function(){if($('#'+idtrig).is(":checked")==true){$(".cond_"+idtrig).removeClass("hiderow");}else{$(".cond_"+idtrig).addClass("hiderow");}});});});}
return $opt;}
display_element.html(' ');display_element.append(trial.progbar);var $preamb=$('<div/>').attr("id","preamb").html(trial.preamble).addClass("form_preamble");display_element.append($preamb);var $formdiv=$('<div/>').attr("id","theform").addClass("form_div");display_element.append($formdiv);for(var i=0;i<trial.nrow;i++){var elm=trial.form_element[i];if(elm.type=='text'){var $txt_quest=$('<label/>').attr("for",elm.idname).addClass("form_col").addClass(elm.condclass).html(elm.quest);var $txt_inp=$('<input/>').attr("type",elm.type).attr("id",elm.idname).attr("name",elm.idname).attr("style","width:"+elm.inpwidth+"em").addClass(elm.condclass).addClass("form_resp");$('#theform').append($txt_quest,$txt_inp);}
if(elm.type=='radio'){var $quest=$('<span/>').addClass("form_col").html(elm.quest).addClass(elm.condclass);$('#theform').append($quest);for(var j=0;j<elm.optstr.length;j++){var $opt_lab=$('<label/>').attr("id","lab"+elm.optid[j]).attr("for",elm.optid[j]).html(elm.optstr[j]).addClass(elm.type+"_lab").addClass(elm.condclass);var $opt_inp=$('<input/>').attr("type",elm.type).attr("id",elm.optid[j]).attr("name",elm.idname).attr("value",elm.optid[j]).addClass(elm.type+"_but").addClass(elm.condclass).addClass("form_resp");$opt_inp=addoptfunc(elm.optfunc[j],$opt_inp);$('#theform').append($opt_lab);$('#lab'+elm.optid[j]).prepend($opt_inp);}}
if(elm.type=='checkbox'){var $quest=$('<span/>').addClass("form_col").html(elm.quest).addClass(elm.condclass);$('#theform').append($quest);for(var j=0;j<elm.optstr.length;j++){var $opt_lab=$('<label/>').addClass("checkbox_lab").attr("for",elm.optid[j]).html(elm.optstr[j]).addClass(elm.condclass);var $opt_inp=$('<input/>').attr("type",elm.type).attr("id",elm.optid[j]).attr("name",elm.idname).attr("value",elm.optid[j]).addClass(elm.condclass).addClass("form_resp");$opt_inp=addoptfunc(elm.optfunc[j],$opt_inp);var $spanlab=$('<span/>').addClass("checkbox_cont");$spanlab.append($opt_inp,$opt_lab);$('#theform').append($spanlab);}
if(elm.ncblim>0){var checkboxes=$('input[name='+elm.idname+']');var max=elm.ncblim;checkboxes.change(function(){var current=checkboxes.filter(':checked').length;checkboxes.filter(':not(:checked)').prop('disabled',current>=max);});}}
if(elm.type=='list'){var $quest=$('<span/>').addClass("form_col").html(elm.quest).addClass(elm.condclass);$('#theform').append($quest);var $list_sel=$('<select/>').attr("name",elm.idname).attr("id","list_"+elm.idname).addClass(elm.condclass);$('#theform').append($list_sel);var $list_opt=$('<option/>').attr("value","no_selection").html("SÃ©lectionner").addClass(elm.condclass);$('#list_'+elm.idname).append($list_opt);for(var j=0;j<elm.optstr.length;j++){var $list_opt=$('<option/>').attr("value",elm.optid[j]).attr("id",elm.optid[j]).html(elm.optstr[j]).addClass(elm.condclass);$list_opt=addoptfunc(elm.optfunc[j],$list_opt);$('#list_'+elm.idname).append($list_opt);}}
$('#theform').append("<br />");}
var $subm=$('<div />').attr('id',"subbut").addClass("form_subbutton");$('#theform').append($subm);var $but=$('<a />').attr("id","submit").addClass('button').html("<span id='subbut_txt'>"+trial.submit+"</span>");$('#subbut').append($but);$("#submit").click(function(){var endTime=(new Date()).getTime();var response_time=endTime-startTime;$("#theform select").each(function(index){var fname=$(this).attr("name");var val=$(this).val();var $selinput=$('<input/>').attr("type","hidden").attr("name",fname).attr("value",val).addClass("form_resp");$("#theform").append($selinput);});var form_data={};$(".form_resp").each(function(index){var intyp=$(this).attr("type");var fname=$(this).attr("name");var val=$(this).val();if((typeof form_data[fname]=="undefined")&&(intyp!="checkbox")){form_data[fname]="NA";}
if((intyp=="text")||(intyp=="hidden")||((intyp=="radio")&&($(this).is(":checked")==true))){if(val==""){val="NA";}
form_data[fname]=val;}
if(intyp=="checkbox"){if($(this).is(":checked")==true){form_data[val]=1;}else{form_data[val]=0;}}});var form_data={"rt":response_time,"responses":JSON.stringify(form_data)};display_element.html('');jsPsych.finishTrial(form_data);});var startTime=(new Date()).getTime();};return plugin;})();